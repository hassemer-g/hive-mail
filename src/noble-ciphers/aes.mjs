/* esm.sh - @noble/ciphers@2.0.1/aes */
import{ghash as rt,polyval as At}from"./_polyval.mjs";import{abytes as K,anumber as Ct,clean as m,complexOverlapBytes as F,concatBytes as Kt,copyBytes as A,createView as it,equalBytes as G,getOutput as N,isAligned32 as U,overlapBytes as Ut,u32 as L,u64Lengths as St,u8 as tt,wrapCipher as k}from"./utils.mjs";var T=16,nt=4,D=new Uint8Array(T),Tt=283;function lt(n){if(![16,24,32].includes(n.length))throw new Error('"aes key" expected Uint8Array of length 16/24/32, got length='+n.length)}function et(n){return n<<1^Tt&-(n>>7)}function z(n,r){let t=0;for(;r>0;r>>=1)t^=n&-(r&1),n=et(n);return t}var Z=(n,r,t=1)=>{if(!Number.isSafeInteger(t))throw new Error("incBytes: wrong carry "+t);K(n);for(let e=0;e<n.length;e++){let o=r?e:n.length-1-e;t=t+(n[o]&255)|0,n[o]=t&255,t>>>=8}},X=(()=>{let n=new Uint8Array(256);for(let t=0,e=1;t<256;t++,e^=et(e))n[t]=e;let r=new Uint8Array(256);r[0]=99;for(let t=0;t<255;t++){let e=n[255-t];e|=e<<8,r[n[t]]=(e^e>>4^e>>5^e>>6^e>>7^99)&255}return m(n),r})(),Bt=X.map((n,r)=>X.indexOf(r)),_t=n=>n<<24|n>>>8,Q=n=>n<<8|n>>>24,q=n=>n<<24&4278190080|n<<8&16711680|n>>>8&65280|n>>>24&255;function ft(n,r){if(n.length!==256)throw new Error("Wrong sbox length");let t=new Uint32Array(256).map((i,a)=>r(n[a])),e=t.map(Q),o=e.map(Q),c=o.map(Q),l=new Uint32Array(256*256),f=new Uint32Array(256*256),s=new Uint16Array(256*256);for(let i=0;i<256;i++)for(let a=0;a<256;a++){let u=i*256+a;l[u]=t[i]^e[a],f[u]=o[i]^c[a],s[u]=n[i]<<8|n[a]}return{sbox:n,sbox2:s,T0:t,T1:e,T2:o,T3:c,T01:l,T23:f}}var ot=ft(X,n=>z(n,3)<<24|n<<16|n<<8|z(n,2)),at=ft(Bt,n=>z(n,11)<<24|z(n,13)<<16|z(n,9)<<8|z(n,14)),It=(()=>{let n=new Uint8Array(16);for(let r=0,t=1;r<16;r++,t=et(t))n[r]=t;return n})();function _(n){K(n);let r=n.length;lt(n);let{sbox2:t}=ot,e=[];U(n)||e.push(n=A(n));let o=L(n),c=o.length,l=s=>B(t,s,s,s,s),f=new Uint32Array(r+28);f.set(o);for(let s=c;s<f.length;s++){let i=f[s-1];s%c===0?i=l(_t(i))^It[s/c-1]:c>6&&s%c===4&&(i=l(i)),f[s]=f[s-c]^i}return m(...e),f}function J(n){let r=_(n),t=r.slice(),e=r.length,{sbox2:o}=ot,{T0:c,T1:l,T2:f,T3:s}=at;for(let i=0;i<e;i+=4)for(let a=0;a<4;a++)t[i+a]=r[e-i-4+a];m(r);for(let i=4;i<e-4;i++){let a=t[i],u=B(o,a,a,a,a);t[i]=c[u&255]^l[u>>>8&255]^f[u>>>16&255]^s[u>>>24]}return t}function M(n,r,t,e,o,c){return n[t<<8&65280|e>>>8&255]^r[o>>>8&65280|c>>>24&255]}function B(n,r,t,e,o){return n[r&255|t&65280]|n[e>>>16&255|o>>>16&65280]<<16}function S(n,r,t,e,o){let{sbox2:c,T01:l,T23:f}=ot,s=0;r^=n[s++],t^=n[s++],e^=n[s++],o^=n[s++];let i=n.length/4-2;for(let g=0;g<i;g++){let w=n[s++]^M(l,f,r,t,e,o),p=n[s++]^M(l,f,t,e,o,r),b=n[s++]^M(l,f,e,o,r,t),d=n[s++]^M(l,f,o,r,t,e);r=w,t=p,e=b,o=d}let a=n[s++]^B(c,r,t,e,o),u=n[s++]^B(c,t,e,o,r),h=n[s++]^B(c,e,o,r,t),y=n[s++]^B(c,o,r,t,e);return{s0:a,s1:u,s2:h,s3:y}}function j(n,r,t,e,o){let{sbox2:c,T01:l,T23:f}=at,s=0;r^=n[s++],t^=n[s++],e^=n[s++],o^=n[s++];let i=n.length/4-2;for(let g=0;g<i;g++){let w=n[s++]^M(l,f,r,o,e,t),p=n[s++]^M(l,f,t,r,o,e),b=n[s++]^M(l,f,e,t,r,o),d=n[s++]^M(l,f,o,e,t,r);r=w,t=p,e=b,o=d}let a=n[s++]^B(c,r,o,e,t),u=n[s++]^B(c,t,r,o,e),h=n[s++]^B(c,e,t,r,o),y=n[s++]^B(c,o,e,t,r);return{s0:a,s1:u,s2:h,s3:y}}function ut(n,r,t,e){K(r,T,"nonce"),K(t);let o=t.length;e=N(o,e),F(t,e);let c=r,l=L(c),{s0:f,s1:s,s2:i,s3:a}=S(n,l[0],l[1],l[2],l[3]),u=L(t),h=L(e);for(let g=0;g+4<=u.length;g+=4)h[g+0]=u[g+0]^f,h[g+1]=u[g+1]^s,h[g+2]=u[g+2]^i,h[g+3]=u[g+3]^a,Z(c,!1,1),{s0:f,s1:s,s2:i,s3:a}=S(n,l[0],l[1],l[2],l[3]);let y=T*Math.floor(u.length/nt);if(y<o){let g=new Uint32Array([f,s,i,a]),w=tt(g);for(let p=y,b=0;p<o;p++,b++)e[p]=t[p]^w[b];m(g)}return e}function P(n,r,t,e,o){K(t,T,"nonce"),K(e),o=N(e.length,o);let c=t,l=L(c),f=it(c),s=L(e),i=L(o),a=r?0:12,u=e.length,h=f.getUint32(a,r),{s0:y,s1:g,s2:w,s3:p}=S(n,l[0],l[1],l[2],l[3]);for(let d=0;d+4<=s.length;d+=4)i[d+0]=s[d+0]^y,i[d+1]=s[d+1]^g,i[d+2]=s[d+2]^w,i[d+3]=s[d+3]^p,h=h+1>>>0,f.setUint32(a,h,r),{s0:y,s1:g,s2:w,s3:p}=S(n,l[0],l[1],l[2],l[3]);let b=T*Math.floor(s.length/nt);if(b<u){let d=new Uint32Array([y,g,w,p]),C=tt(d);for(let E=b,v=0;E<u;E++,v++)o[E]=e[E]^C[v];m(d)}return o}var R=k({blockSize:16,nonceLength:16},function(r,t){function e(o,c){if(K(o),c!==void 0&&(K(c),!U(c)))throw new Error("unaligned destination");let l=_(r),f=A(t),s=[l,f];U(o)||s.push(o=A(o));let i=ut(l,f,o,c);return m(...s),i}return{encrypt:(o,c)=>e(o,c),decrypt:(o,c)=>e(o,c)}});function ht(n){if(K(n),n.length%T!==0)throw new Error("aes-(cbc/ecb).decrypt ciphertext should consist of blocks with size "+T)}function gt(n,r,t){K(n);let e=n.length,o=e%T;if(!r&&o!==0)throw new Error("aec/(cbc-ecb): unpadded plaintext with disabled padding");U(n)||(n=A(n));let c=L(n);if(r){let f=T-o;f||(f=T),e=e+f}t=N(e,t),F(n,t);let l=L(t);return{b:c,o:l,out:t}}function yt(n,r){if(!r)return n;let t=n.length;if(!t)throw new Error("aes/pcks5: empty ciphertext not allowed");let e=n[t-1];if(e<=0||e>16)throw new Error("aes/pcks5: wrong padding");let o=n.subarray(0,-e);for(let c=0;c<e;c++)if(n[t-c-1]!==e)throw new Error("aes/pcks5: wrong padding");return o}function pt(n){let r=new Uint8Array(16),t=L(r);r.set(n);let e=T-n.length;for(let o=T-e;o<T;o++)r[o]=e;return t}var Pt=k({blockSize:16},function(r,t={}){let e=!t.disablePadding;return{encrypt(o,c){let{b:l,o:f,out:s}=gt(o,e,c),i=_(r),a=0;for(;a+4<=l.length;){let{s0:u,s1:h,s2:y,s3:g}=S(i,l[a+0],l[a+1],l[a+2],l[a+3]);f[a++]=u,f[a++]=h,f[a++]=y,f[a++]=g}if(e){let u=pt(o.subarray(a*4)),{s0:h,s1:y,s2:g,s3:w}=S(i,u[0],u[1],u[2],u[3]);f[a++]=h,f[a++]=y,f[a++]=g,f[a++]=w}return m(i),s},decrypt(o,c){ht(o);let l=J(r);c=N(o.length,c);let f=[l];U(o)||f.push(o=A(o)),F(o,c);let s=L(o),i=L(c);for(let a=0;a+4<=s.length;){let{s0:u,s1:h,s2:y,s3:g}=j(l,s[a+0],s[a+1],s[a+2],s[a+3]);i[a++]=u,i[a++]=h,i[a++]=y,i[a++]=g}return m(...f),yt(c,e)}}}),Nt=k({blockSize:16,nonceLength:16},function(r,t,e={}){let o=!e.disablePadding;return{encrypt(c,l){let f=_(r),{b:s,o:i,out:a}=gt(c,o,l),u=t,h=[f];U(u)||h.push(u=A(u));let y=L(u),g=y[0],w=y[1],p=y[2],b=y[3],d=0;for(;d+4<=s.length;)g^=s[d+0],w^=s[d+1],p^=s[d+2],b^=s[d+3],{s0:g,s1:w,s2:p,s3:b}=S(f,g,w,p,b),i[d++]=g,i[d++]=w,i[d++]=p,i[d++]=b;if(o){let C=pt(c.subarray(d*4));g^=C[0],w^=C[1],p^=C[2],b^=C[3],{s0:g,s1:w,s2:p,s3:b}=S(f,g,w,p,b),i[d++]=g,i[d++]=w,i[d++]=p,i[d++]=b}return m(...h),a},decrypt(c,l){ht(c);let f=J(r),s=t,i=[f];U(s)||i.push(s=A(s));let a=L(s);l=N(c.length,l),U(c)||i.push(c=A(c)),F(c,l);let u=L(c),h=L(l),y=a[0],g=a[1],w=a[2],p=a[3];for(let b=0;b+4<=u.length;){let d=y,C=g,E=w,v=p;y=u[b+0],g=u[b+1],w=u[b+2],p=u[b+3];let{s0:I,s1:O,s2:x,s3:W}=j(f,y,g,w,p);h[b++]=I^d,h[b++]=O^C,h[b++]=x^E,h[b++]=W^v}return m(...i),yt(l,o)}}}),Ot=k({blockSize:16,nonceLength:16},function(r,t){function e(o,c,l){K(o);let f=o.length;if(l=N(f,l),Ut(o,l))throw new Error("overlapping src and dst not supported.");let s=_(r),i=t,a=[s];U(i)||a.push(i=A(i)),U(o)||a.push(o=A(o));let u=L(o),h=L(l),y=c?h:u,g=L(i),w=g[0],p=g[1],b=g[2],d=g[3];for(let E=0;E+4<=u.length;){let{s0:v,s1:I,s2:O,s3:x}=S(s,w,p,b,d);h[E+0]=u[E+0]^v,h[E+1]=u[E+1]^I,h[E+2]=u[E+2]^O,h[E+3]=u[E+3]^x,w=y[E++],p=y[E++],b=y[E++],d=y[E++]}let C=T*Math.floor(u.length/nt);if(C<f){({s0:w,s1:p,s2:b,s3:d}=S(s,w,p,b,d));let E=tt(new Uint32Array([w,p,b,d]));for(let v=C,I=0;v<f;v++,I++)l[v]=o[v]^E[I];m(E)}return m(...a),l}return{encrypt:(o,c)=>e(o,!0,c),decrypt:(o,c)=>e(o,!1,c)}});function wt(n,r,t,e,o){let c=o?o.length:0,l=n.create(t,e.length+c);o&&l.update(o);let f=St(8*e.length,8*c,r);l.update(e),l.update(f);let s=l.digest();return m(f),s}var xt=k({blockSize:16,nonceLength:12,tagLength:16,varSizeNonce:!0},function(r,t,e){if(t.length<8)throw new Error("aes/gcm: invalid nonce length");let o=16;function c(f,s,i){let a=wt(rt,!1,f,i,e);for(let u=0;u<s.length;u++)a[u]^=s[u];return a}function l(){let f=_(r),s=D.slice(),i=D.slice();if(P(f,!1,i,i,s),t.length===12)i.set(t);else{let u=D.slice();it(u).setBigUint64(8,BigInt(t.length*8),!1);let y=rt.create(s).update(t).update(u);y.digestInto(i),y.destroy()}let a=P(f,!1,i,D);return{xk:f,authKey:s,counter:i,tagMask:a}}return{encrypt(f){let{xk:s,authKey:i,counter:a,tagMask:u}=l(),h=new Uint8Array(f.length+o),y=[s,i,a,u];U(f)||y.push(f=A(f)),P(s,!1,a,f,h.subarray(0,f.length));let g=c(i,u,h.subarray(0,h.length-o));return y.push(g),h.set(g,f.length),m(...y),h},decrypt(f){let{xk:s,authKey:i,counter:a,tagMask:u}=l(),h=[s,i,u,a];U(f)||h.push(f=A(f));let y=f.subarray(0,-o),g=f.subarray(-o),w=c(i,u,y);if(h.push(w),!G(w,g))throw new Error("aes/gcm: invalid ghash tag");let p=P(s,!1,a,y);return m(...h),p}}}),Y=(n,r,t)=>e=>{if(!Number.isSafeInteger(e)||r>e||e>t){let o="["+r+".."+t+"]";throw new Error(""+n+": expected value in range "+o+", got "+e)}},Mt=k({blockSize:16,nonceLength:12,tagLength:16,varSizeNonce:!0},function(r,t,e){let c=Y("AAD",0,68719476736),l=Y("plaintext",0,2**36),f=Y("nonce",12,12),s=Y("ciphertext",16,2**36+16);K(r),lt(r),f(t.length),e!==void 0&&c(e.length);function i(){let h=_(r),y=new Uint8Array(r.length),g=new Uint8Array(16),w=[h,y],p=t;U(p)||w.push(p=A(p));let b=L(p),d=0,C=b[0],E=b[1],v=b[2],I=0;for(let x of[g,y].map(L)){let W=L(x);for(let V=0;V<W.length;V+=2){let{s0:mt,s1:vt}=S(h,d,C,E,v);W[V+0]=mt,W[V+1]=vt,d=++I}}let O={authKey:g,encKey:_(y)};return m(...w),O}function a(h,y,g){let w=wt(At,!0,y,g,e);for(let v=0;v<12;v++)w[v]^=t[v];w[15]&=127;let p=L(w),b=p[0],d=p[1],C=p[2],E=p[3];return{s0:b,s1:d,s2:C,s3:E}=S(h,b,d,C,E),p[0]=b,p[1]=d,p[2]=C,p[3]=E,w}function u(h,y,g){let w=A(y);w[15]|=128;let p=P(h,!0,w,g);return m(w),p}return{encrypt(h){l(h.length);let{encKey:y,authKey:g}=i(),w=a(y,g,h),p=[y,g,w];U(h)||p.push(h=A(h));let b=new Uint8Array(h.length+16);return b.set(w,h.length),b.set(u(y,w,h)),m(...p),b},decrypt(h){s(h.length);let y=h.subarray(-16),{encKey:g,authKey:w}=i(),p=[g,w];U(h)||p.push(h=A(h));let b=u(g,y,h.subarray(0,-16)),d=a(g,w,b);if(p.push(d),!G(y,d))throw m(...p),new Error("invalid polyval tag");return m(...p),b}}}),Wt=Mt;function dt(n){return n instanceof Uint32Array||ArrayBuffer.isView(n)&&n.constructor.name==="Uint32Array"}function bt(n,r){if(K(r,16,"block"),!dt(n))throw new Error("_encryptBlock accepts result of expandKeyLE");let t=L(r),{s0:e,s1:o,s2:c,s3:l}=S(n,t[0],t[1],t[2],t[3]);return t[0]=e,t[1]=o,t[2]=c,t[3]=l,r}function Et(n,r){if(K(r,16,"block"),!dt(n))throw new Error("_decryptBlock accepts result of expandKeyLE");let t=L(r),{s0:e,s1:o,s2:c,s3:l}=j(n,t[0],t[1],t[2],t[3]);return t[0]=e,t[1]=o,t[2]=c,t[3]=l,r}var H={encrypt(n,r){if(r.length>=2**32)throw new Error("plaintext should be less than 4gb");let t=_(n);if(r.length===16)bt(t,r);else{let e=L(r),o=e[0],c=e[1];for(let l=0,f=1;l<6;l++)for(let s=2;s<e.length;s+=2,f++){let{s0:i,s1:a,s2:u,s3:h}=S(t,o,c,e[s],e[s+1]);o=i,c=a^q(f),e[s]=u,e[s+1]=h}e[0]=o,e[1]=c}t.fill(0)},decrypt(n,r){if(r.length-8>=2**32)throw new Error("ciphertext should be less than 4gb");let t=J(n),e=r.length/8-1;if(e===1)Et(t,r);else{let o=L(r),c=o[0],l=o[1];for(let f=0,s=e*6;f<6;f++)for(let i=e*2;i>=1;i-=2,s--){l^=q(s);let{s0:a,s1:u,s2:h,s3:y}=j(t,c,l,o[i],o[i+1]);c=a,l=u,o[i]=h,o[i+1]=y}o[0]=c,o[1]=l}t.fill(0)}},st=new Uint8Array(8).fill(166),jt=k({blockSize:8},n=>({encrypt(r){if(!r.length||r.length%8!==0)throw new Error("invalid plaintext length");if(r.length===8)throw new Error("8-byte keys not allowed in AESKW, use AESKWP instead");let t=Kt(st,r);return H.encrypt(n,t),t},decrypt(r){if(r.length%8!==0||r.length<24)throw new Error("invalid ciphertext length");let t=A(r);if(H.decrypt(n,t),!G(t.subarray(0,8),st))throw new Error("integrity check failed");return t.subarray(0,8).fill(0),t.subarray(8)}})),ct=2790873510,Vt=k({blockSize:8},n=>({encrypt(r){if(!r.length)throw new Error("invalid plaintext length");let t=Math.ceil(r.length/8)*8,e=new Uint8Array(8+t);e.set(r,8);let o=L(e);return o[0]=ct,o[1]=q(r.length),H.encrypt(n,e),e},decrypt(r){if(r.length<16)throw new Error("invalid ciphertext length");let t=A(r),e=L(t);H.decrypt(n,t);let o=q(e[1])>>>0,c=Math.ceil(o/8)*8;if(e[0]!==ct||t.length-8!==c)throw new Error("integrity check failed");for(let l=o;l<c;l++)if(t[8+l]!==0)throw new Error("integrity check failed");return t.subarray(0,8).fill(0),t.subarray(8,8+o)}})),$=class{blockLen;key;nonce;state;reseedCnt;constructor(r,t,e){this.blockLen=R.blockSize;let o=r/8,c=16;this.state=new Uint8Array(o+c),this.key=this.state.subarray(0,o),this.nonce=this.state.subarray(o,o+c),this.reseedCnt=1,Z(this.nonce,!1,1),this.addEntropy(t,e)}update(r){if(R(this.key,this.nonce).encrypt(new Uint8Array(this.state.length),this.state),r){K(r);for(let t=0;t<r.length;t++)this.state[t]^=r[t]}Z(this.nonce,!1,1)}addEntropy(r,t){K(r,this.state.length,"seed");let e=r.slice();if(t){if(K(t),t.length>e.length)throw new Error("info length is too big");for(let o=0;o<t.length;o++)e[o]^=t[o]}this.update(e),e.fill(0),this.reseedCnt=1}randomBytes(r,t){if(Ct(r),this.reseedCnt++>=2**48)throw new Error("entropy exhausted");t&&this.update(t);let e=new Uint8Array(r);return R(this.key,this.nonce).encrypt(e,e),Z(this.nonce,!1,Math.ceil(r/this.blockLen)),this.update(t),e}clean(){this.state.fill(0),this.reseedCnt=0}},Lt=n=>(r,t=void 0)=>new $(n,r,t),Dt=Lt(128),Yt=Lt(256),Zt={expandKeyLE:_,expandKeyDecLE:J,encrypt:S,decrypt:j,encryptBlock:bt,decryptBlock:Et,ctrCounter:ut,ctr32:P};export{jt as aeskw,Vt as aeskwp,Nt as cbc,Ot as cfb,R as ctr,Pt as ecb,xt as gcm,Mt as gcmsiv,Dt as rngAesCtrDrbg128,Yt as rngAesCtrDrbg256,Wt as siv,Zt as unsafe};
//# sourceMappingURL=aes.mjs.map
